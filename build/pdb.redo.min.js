/**
 * Copyright 2015-2016 Mandar Deshpande <mandar@ebi.ac.uk>
 * European Bioinformatics Institute (EBI, http://www.ebi.ac.uk/)
 * European Molecular Biology Laboratory (EMBL, http://www.embl.de/)
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and 
 * limitations under the License.
 */
!function(){"use strict";angular.module("pdb.redo.services",[]).service("pdbRedoService",["$http","$q",function(e,d){this.createNewEvent=function(e){var d={};return angular.forEach(e,function(e){var r;"function"==typeof MouseEvent?r=new MouseEvent(e,{view:window,bubbles:!0,cancelable:!0}):"function"==typeof document.createEvent?(r=document.createEvent("MouseEvents"),r.initEvent(e,!0,!0)):"function"==typeof document.createEventObject&&(r=document.createEventObject()),d[e]=r}),d},this.getApiData=function(r){var o="//www.cmbi.ru.nl/pdb_redo/cgi-bin/json.pl?id="+r,t=d.defer();return e.get(o).then(function(e){t.resolve(e.data)},function(){t.reject("fail response")}),t.promise}}])}(),function(){"use strict";angular.module("pdb.redo",["pdb.redo.services","template/pdbRedo/pdbRedo.html"]).directive("pdbRedo",["pdbRedoService",function(e){return{restrict:"EAC",scope:{pdbId:"@",headingText:"@",errorText:"@",subheadingText:"@"},templateUrl:"template/pdbRedo/pdbRedo.html",link:function(d,r){if(d.showWrapper=!0,d.showGeometry=!0,d.showModelFit=!0,d.showLoader=!0,d.pdbevents=e.createNewEvent(["PDB.pdbRedo.api.loaded","PDB.pdbRedo.loaded","PDB.pdbRedo.failed"]),"undefined"==typeof d.pdbId||""===d.pdbId||4!==d.pdbId.length)return d.errorMsg="Invalid PDB ID!",d.dispatchEvent("PDB.pdbRedo.failed",{pdbId:d.pdbId,error:d.errorMsg}),void 0;("undefined"==typeof d.headingText||""===d.headingText)&&(d.headingText="PDB_REDO model quality changes"),"undefined"!=typeof d.errorText&&(d.errorMsg=d.errorText),d.styles={geometryFrame:{},modelFitFrame:{}},d.frameWidth=r[0].querySelector(".pcl-pdbRedo-position-frame").offsetWidth;var o=function(e){var o=!1,t=!1;if(d.frameWidth=r[0].querySelector(".pcl-pdbRedo-position-frame").offsetWidth,"undefined"!=typeof e&&"undefined"!=typeof e.geometry&&null!==e.geometry)for(var i=e.geometry["range-upper"]-e.geometry["range-lower"],a=i/5,p=1,n=0;5>n;n++){if(e.geometry.dzscore>e.geometry["range-upper"]-a*p){d.styles.geometryFrame={right:d.frameWidth*n+"px"};break}p++}else o=!0;if("undefined"!=typeof e&&"undefined"!=typeof e.ddatafit&&null!==e.ddatafit){var s=e.ddatafit["range-upper"]-e.ddatafit["range-lower"],l=s/5;p=1;for(var n=0;5>n;n++){if(e.ddatafit.zdfree>e.ddatafit["range-upper"]-l*p){d.styles.modelFitFrame={right:d.frameWidth*n+"px"};break}p++}}else t=!0;o===!0&&t===!0?d.showWrapper=!1:o===!0?(d.showWrapper=!0,d.showGeometry=!1):t===!0?(d.showWrapper=!0,d.showModelFit=!1):d.showWrapper=!0,d.showLoader=!1,d.$apply()};d.dispatchEvent=function(e,o,t){var i=r[0];"undefined"!=typeof t&&(i=t),"undefined"!=typeof o&&(d.pdbevents[e].eventData=o),i.dispatchEvent(d.pdbevents[e])};e.getApiData(d.pdbId).then(function(e){d.dispatchEvent("PDB.pdbRedo.api.loaded",{pdbId:d.pdbId}),setTimeout(function(){o(e),1==d.showWrapper?d.dispatchEvent("PDB.pdbRedo.loaded",{pdbId:d.pdbId}):(d.errorMsg="undefined"!=typeof d.errorText?d.errorText:"Error: Data not Available!",d.dispatchEvent("PDB.pdbRedo.failed",{pdbId:d.pdbId,error:d.errorMsg}))},100)},function(e){d.showWrapper=!1,window.console&&console.log("API request failed. Error: "+e),d.errorMsg="undefined"!=typeof d.errorText?d.errorText:"Error: "+e,d.dispatchEvent("PDB.pdbRedo.failed",{pdbId:d.pdbId,error:d.errorMsg})})}}}])}(),angular.module("template/pdbRedo/pdbRedo.html",[]).run(["$templateCache",function(e){e.put("template/pdbRedo/pdbRedo.html",'<div class="pcl-pdbRedo-wrapper" ng-show="showWrapper"><div class="pcl-pdbRedo-loader" ng-show="showLoader"><img ng-src="//www.ebi.ac.uk/pdbe/widgets/html/loading.gif" border="0"></div><div class="pcl-pdbRedo-heading">{{headingText}}</div><p>{{subheadingText}}</p><div class="pcl-pdbRedo-row"><div class="pcl-pdbRedo-label">Model Geometry</div><div class="pcl-pdbRedo-gradient" ng-show="showGeometry">&nbsp;</div><div class="pcl-pdbRedo-position-frame" ng-style="styles.geometryFrame" ng-show="showGeometry">&nbsp;</div><div class="pcl-pdbRedo-error" ng-hide="showGeometry">Data not available</div></div><div class="pcl-pdbRedo-row"><div class="pcl-pdbRedo-label">Fit model/data</div><div class="pcl-pdbRedo-gradient" ng-show="showModelFit">&nbsp;</div><div class="pcl-pdbRedo-position-frame" ng-style="styles.modelFitFrame" ng-show="showModelFit">&nbsp;</div><div class="pcl-pdbRedo-error" ng-hide="showModelFit">Data not available</div></div><div class="pcl-pdbRedo-link-row"><a target="_blank" href="http://www.cmbi.ru.nl/pdb_redo/cgi-bin/redir2.pl?pdbCode={{pdbId}}">PDB_REDO</a></div></div><div ng-hide="showWrapper">{{errorMsg}}</div>')}]);