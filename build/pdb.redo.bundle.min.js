/**
 * Copyright 2015-2016 Mandar Deshpande <mandar@ebi.ac.uk>
 * European Bioinformatics Institute (EBI, http://www.ebi.ac.uk/)
 * European Molecular Biology Laboratory (EMBL, http://www.embl.de/)
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and 
 * limitations under the License.
 */
!function(){"use strict";angular.module("pdb.redo",["pdb.redo.services","template/pdbRedo/pdbRedo.html"]).directive("pdbRedo",["pdbRedoService",function(e){return{restrict:"EAC",scope:{pdbId:"@",headingText:"@",errorText:"@",subheadingText:"@"},templateUrl:"template/pdbRedo/pdbRedo.html",link:function(d,t){if(d.showWrapper=!0,d.showGeometry=!0,d.showModelFit=!0,d.showLoader=!0,d.pdbevents=e.createNewEvent(["PDB.pdbRedo.api.loaded","PDB.pdbRedo.loaded","PDB.pdbRedo.failed"]),"undefined"==typeof d.pdbId||""===d.pdbId||4!==d.pdbId.length)return d.errorMsg="Invalid PDB ID!",d.dispatchEvent("PDB.pdbRedo.failed",{pdbId:d.pdbId,error:d.errorMsg}),void 0;("undefined"==typeof d.headingText||""===d.headingText)&&(d.headingText="PDB_REDO model quality changes"),"undefined"!=typeof d.errorText&&(d.errorMsg=d.errorText),d.styles={geometryFrame:{},modelFitFrame:{}},d.frameWidth=t[0].querySelector(".pcl-pdbRedo-position-frame").offsetWidth;var r=function(e){var r=!1,o=!1;if(d.frameWidth=t[0].querySelector(".pcl-pdbRedo-position-frame").offsetWidth,"undefined"!=typeof e&&"undefined"!=typeof e.geometry&&null!==e.geometry)for(var a=e.geometry["range-upper"]-e.geometry["range-lower"],i=a/5,n=1,p=0;5>p;p++){if(e.geometry.dzscore>e.geometry["range-upper"]-i*n){d.styles.geometryFrame={right:d.frameWidth*p+"px"};break}n++}else r=!0;if("undefined"!=typeof e&&"undefined"!=typeof e.ddatafit&&null!==e.ddatafit){var s=e.ddatafit["range-upper"]-e.ddatafit["range-lower"],l=s/5;n=1;for(var p=0;5>p;p++){if(e.ddatafit.zdfree>e.ddatafit["range-upper"]-l*n){d.styles.modelFitFrame={right:d.frameWidth*p+"px"};break}n++}}else o=!0;r===!0&&o===!0?d.showWrapper=!1:r===!0?(d.showWrapper=!0,d.showGeometry=!1):o===!0?(d.showWrapper=!0,d.showModelFit=!1):d.showWrapper=!0,d.showLoader=!1,d.$apply()};d.dispatchEvent=function(e,r,o){var a=t[0];"undefined"!=typeof o&&(a=o),"undefined"!=typeof r&&(d.pdbevents[e].eventData=r),a.dispatchEvent(d.pdbevents[e])};e.getApiData(d.pdbId).then(function(e){d.dispatchEvent("PDB.pdbRedo.api.loaded",{pdbId:d.pdbId}),setTimeout(function(){r(e),1==d.showWrapper?d.dispatchEvent("PDB.pdbRedo.loaded",{pdbId:d.pdbId}):(d.errorMsg="undefined"!=typeof d.errorText?d.errorText:"Error: Data not Available!",d.dispatchEvent("PDB.pdbRedo.failed",{pdbId:d.pdbId,error:d.errorMsg}))},100)},function(e){d.showWrapper=!1,d.errorMsg="undefined"!=typeof d.errorText?d.errorText:"Error: API request failed!",d.dispatchEvent("PDB.pdbRedo.failed",{pdbId:d.pdbId,error:d.errorMsg,errorDetails:e})})}}}])}(),function(){"use strict";angular.element(document).ready(function(){angular.bootstrap(document,["pdb.redo"])})}(),function(){"use strict";angular.module("pdb.redo.services",[]).service("pdbRedoService",["$http","$q",function(e,d){this.createNewEvent=function(e){var d={};return angular.forEach(e,function(e){var t;"function"==typeof MouseEvent?t=new MouseEvent(e,{view:window,bubbles:!0,cancelable:!0}):"function"==typeof document.createEvent?(t=document.createEvent("MouseEvents"),t.initEvent(e,!0,!0)):"function"==typeof document.createEventObject&&(t=document.createEventObject()),d[e]=t}),d},this.getApiData=function(t){var r="//pdb-redo.eu/db/"+t+"/pdbe.json",o=d.defer();return e.get(r).then(function(e){o.resolve(e.data)},function(e){o.reject(e)}),o.promise}}])}(),angular.module("template/pdbRedo/pdbRedo.html",[]).run(["$templateCache",function(e){e.put("template/pdbRedo/pdbRedo.html",'<div class="pcl-pdbRedo-wrapper" ng-show="showWrapper"><div class="pcl-pdbRedo-loader" ng-show="showLoader"><img ng-src="//www.ebi.ac.uk/pdbe/widgets/html/loading.gif" border="0"></div><div class="pcl-pdbRedo-heading">{{headingText}}</div><p>{{subheadingText}}</p><div class="pcl-pdbRedo-row"><div class="pcl-pdbRedo-label">Model Geometry</div><div class="pcl-pdbRedo-gradient" ng-show="showGeometry">&nbsp;</div><div class="pcl-pdbRedo-position-frame" ng-style="styles.geometryFrame" ng-show="showGeometry">&nbsp;</div><div class="pcl-pdbRedo-error" ng-hide="showGeometry">Data not available</div></div><div class="pcl-pdbRedo-row"><div class="pcl-pdbRedo-label">Fit model/data</div><div class="pcl-pdbRedo-gradient" ng-show="showModelFit">&nbsp;</div><div class="pcl-pdbRedo-position-frame" ng-style="styles.modelFitFrame" ng-show="showModelFit">&nbsp;</div><div class="pcl-pdbRedo-error" ng-hide="showModelFit">Data not available</div></div><div class="pcl-pdbRedo-link-row"><a target="_blank" href="http://www.cmbi.ru.nl/pdb_redo/cgi-bin/redir2.pl?pdbCode={{pdbId}}">PDB_REDO</a></div></div><div ng-hide="showWrapper">{{errorMsg}}</div>')}]);